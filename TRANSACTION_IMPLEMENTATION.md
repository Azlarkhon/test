# Реализация транзакций для предметов

## Обзор

Была добавлена поддержка транзакций для использования предметов в игре "Морской бой". Теперь все действия предметов выполняются атомарно через систему транзакций, что обеспечивает целостность данных и возможность отката изменений при ошибках.

## Что было сделано

### 1. Создан файл `internal/items/commands.go`

Содержит команды для транзакций, которые соответствуют действиям предметов:

- **OpenCellCommand** - открытие ячейки поля
- **SetCellStatusCommand** - установка статуса ячейки (вода/корабль/обломки)
- **ShootCommand** - выполнение выстрела
- **SetShipCoordinatesCommand** - перемещение корабля

Каждая команда реализует интерфейс `transaction.Command`:
- `Apply(gs *game.GameState) error` - применение изменений
- `Undo(gs *game.GameState)` - откат изменений

### 2. Модифицирована функция `UseItem` в `internal/items/item.go`

Теперь функция:
1. Создает новую транзакцию
2. Парсит скрипт предмета
3. Для каждого действия создает соответствующую команду
4. Добавляет команды в транзакцию
5. Выполняет транзакцию атомарно

### 3. Добавлены тесты

Создан файл `internal/items/transaction_test.go` с тестами для проверки:
- Простого использования предмета
- Предмета с несколькими действиями
- Предмета с изменением статуса ячейки

## Преимущества реализации

### Атомарность
Все действия предмета выполняются как единое целое. Если одно действие падает с ошибкой, все предыдущие изменения откатываются.

### Откат изменений
Каждая команда сохраняет предыдущее состояние и может его восстановить при необходимости.

### Целостность данных
Исключена возможность частичного применения действий предмета, что могло бы привести к некорректному состоянию игры.

### Расширяемость
Легко добавлять новые типы команд для новых действий предметов.

## Пример использования

```go
// Создание предмета
item := Item{
    ID: 1,
    Script: `[
        {"Name":"open_cell","Args":{"x":"$x","y":"$y"}},
        {"Name":"open_cell","Args":{"x":"$x+1","y":"$y"}},
        {"Name":"END_PLAYER_ACTION","Args":{}}
    ]`,
}

// Использование предмета с транзакцией
params := map[string]interface{}{"x": 5, "y": 5}
result, err := UseItem(1, state, itemsMap, params)
if err != nil {
    // Все изменения автоматически откатываются
    log.Printf("Item use failed: %v", err)
}
```

## Поддерживаемые действия

- `OPEN_CELL` - открытие ячейки
- `SET_CELL_STATUS` - установка статуса ячейки
- `MAKE_SHOT` - выполнение выстрела
- `SET_SHIP_COORDINATES` - перемещение корабля
- `END_PLAYER_ACTION` - завершение действия игрока

## Тестирование

Запуск тестов:
```bash
go test ./internal/items/...
```

Все существующие тесты продолжают работать, новые тесты проверяют корректность работы транзакций. 